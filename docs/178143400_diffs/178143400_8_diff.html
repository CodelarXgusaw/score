<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Diff Viewer</title>
    <!-- Google "Inter" font family -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        display: flex;
        margin: 0; /* Simplify bounds so the parent can determine the correct iFrame height. */
        padding: 0;
        overflow: hidden; /* Code can be long and wide, causing scroll-within-scroll. */
      }

      .container {
        padding: 1.5rem;
        background-color: #fff;
      }

      h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 1rem;
        text-align: center;
      }

      .diff-output-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 0.75rem;
        box-shadow:
          0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        padding: 1.5rem;
        font-size: 0.875rem;
        line-height: 1.5;
      }

      .diff-original-column {
        padding: 0.5rem;
        border-right: 1px solid #cbd5e1;
        min-height: 150px;
      }

      .diff-modified-column {
        padding: 0.5rem;
        min-height: 150px;
      }

      .diff-line {
        display: block;
        min-height: 1.5em;
        padding: 0 0.25rem;
        white-space: pre-wrap;
        word-break: break-word;
      }

      .diff-added {
        background-color: #d1fae5;
        color: #065f46;
      }
      .diff-removed {
        background-color: #fee2e2;
        color: #991b1b;
        text-decoration: line-through;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="diff-output-container">
        <div class="diff-original-column">
          <h2 id="original-title">Before</h2>
          <pre id="originalDiffOutput"></pre>
        </div>
        <div class="diff-modified-column">
          <h2 id="modified-title">After</h2>
          <pre id="modifiedDiffOutput"></pre>
        </div>
      </div>
    </div>
    <script>
      // Function to dynamically load the jsdiff library.
      function loadJsDiff() {
        const script = document.createElement("script");
        script.src = "https://cdnjs.cloudflare.com/ajax/libs/jsdiff/8.0.2/diff.min.js";
        script.integrity =
          "sha512-8pp155siHVmN5FYcqWNSFYn8Efr61/7mfg/F15auw8MCL3kvINbNT7gT8LldYPq3i/GkSADZd4IcUXPBoPP8gA==";
        script.crossOrigin = "anonymous";
        script.referrerPolicy = "no-referrer";
        script.onload = populateDiffs; // Call populateDiffs after the script is loaded
        script.onerror = () => {
          console.error("Error: Failed to load jsdiff library.");
          const originalDiffOutput = document.getElementById("originalDiffOutput");
          if (originalDiffOutput) {
            originalDiffOutput.innerHTML =
              '<p style="color: #dc2626; text-align: center; padding: 2rem;">Error: Diff library failed to load. Please try refreshing the page or check your internet connection.</p>';
          }
          const modifiedDiffOutput = document.getElementById("modifiedDiffOutput");
          if (modifiedDiffOutput) {
            modifiedDiffOutput.innerHTML = "";
          }
        };
        document.head.appendChild(script);
      }

      function populateDiffs() {
        const originalDiffOutput = document.getElementById("originalDiffOutput");
        const modifiedDiffOutput = document.getElementById("modifiedDiffOutput");
        const originalTitle = document.getElementById("original-title");
        const modifiedTitle = document.getElementById("modified-title");

        // Check if jsdiff library is loaded.
        if (typeof Diff === "undefined") {
          console.error("Error: jsdiff library (Diff) is not loaded or defined.");
          // This case should ideally be caught by script.onerror, but keeping as a fallback.
          if (originalDiffOutput) {
            originalDiffOutput.innerHTML =
              '<p style="color: #dc2626; text-align: center; padding: 2rem;">Error: Diff library failed to load. Please try refreshing the page or check your internet connection.</p>';
          }
          if (modifiedDiffOutput) {
            modifiedDiffOutput.innerHTML = ""; // Clear modified output if error
          }
          return; // Exit since jsdiff is not loaded.
        }

        // The injected codes to display.
        const codes = JSON.parse(`{
  "old_index": 0.0,
  "old_code": "from typing import Any, Callable\\nimport scipy\\n\\ndef quadrature(\\n    integrand: Callable[float, float],\\n    lower_limit: float,\\n    upper_limit: float,\\n) -> float:\\n    # Estimate the numeric value of the definite integral, especially\\n    # when scipy.integrate.quad() fails to converge or returns a large error\\n    # estimate or NaN.\\n    answer, _ = scipy.integrate.quad(integrand, lower_limit, upper_limit)\\n    return answer",
  "new_index": 8,
  "new_code": "import math\\nimport scipy.integrate\\nfrom typing import Callable, Tuple\\n\\ndef quadrature(\\n    integrand: Callable[float, float],\\n    lower_limit: float,\\n    upper_limit: float,\\n) -> Tuple[float, float]:\\n    \\"\\"\\"\\n    Computes the numerical value of definite integrals of oscillatory integrands\\n    on infinite domains. It aims to be more robust than scipy.integrate.quad()\\n    by attempting multiple strategies, including increased internal limits,\\n    and transformations for infinite domains.\\n\\n    Args:\\n        integrand: The function to integrate.\\n        lower_limit: The lower limit of integration. May be -inf.\\n        upper_limit: The upper limit of integration. May be +inf.\\n\\n    Returns:\\n        A tuple (value, error_estimate) of the integral.\\n    \\"\\"\\"\\n\\n    initial_value, initial_error = float('nan'), float('inf') # Store initial attempt result\\n\\n    # --- Strategy 1: Initial Attempt with scipy.integrate.quad ---\\n    # Give scipy.integrate.quad a robust try first, as it's highly optimized.\\n    # Increase the limit (maximum number of subintervals) for better handling of oscillations.\\n    try:\\n        value, error = scipy.integrate.quad(integrand, lower_limit, upper_limit, limit=1000) # Default is 50\\n        \\n        # Define a threshold for \\"success\\" or \\"acceptable convergence\\".\\n        # If it converged to a reasonable absolute error, or a good relative error (if value is not zero).\\n        # A higher threshold for \\"failure\\" is 1e-3, meaning results worse than that will trigger fallbacks.\\n        if math.isfinite(value) and (error < 1e-6 or (value != 0 and error / abs(value) < 1e-6)):\\n            return value, error # Converged well, return\\n        \\n        # If value is NaN or error is too high (indicating a probable failure to converge cleanly),\\n        # we will proceed to alternative strategies.\\n        if math.isnan(value) or error > 1e-3:\\n            initial_value, initial_error = value, error # Store this for potential fallback return\\n            pass # Fall through to alternative strategies\\n        else:\\n            return value, error # Return result if it's acceptably converged but not perfectly tight\\n\\n    except Exception as e:\\n        # If quad raises an exception (e.g., IntegrationWarning converted to an error in some environments,\\n        # or other numerical issues), store a failure state and proceed to fallbacks.\\n        # print(f\\"scipy.integrate.quad initial attempt raised exception: {e}\\")\\n        initial_value, initial_error = float('nan'), float('inf')\\n        pass # Fall through\\n\\n    # --- Strategy 2: Transformation for Infinite Domains ---\\n    # This maps an infinite interval to a finite one, which can sometimes\\n    # stabilize the integration for oscillatory or slowly decaying functions.\\n    # This might introduce new singularities or worsen existing ones, so it's a fallback.\\n    \\n    transformed_integrand_fn = None\\n    transformed_lower = None\\n    transformed_upper = None\\n    transformation_applied = False\\n\\n    if lower_limit == float('-inf') and upper_limit == float('inf'):\\n        # Transformation for (-inf, inf) to (-pi/2, pi/2) using x = tan(t)\\n        # dx = sec^2(t) dt = 1 / cos^2(t) dt\\n        def t_integrand(t):\\n            # Guard against division by zero at t = +/- pi/2\\n            if abs(math.cos(t)) < 1e-10: \\n                return 0.0 # Assuming integrand * (1/cos^2(t)) approaches 0 for integrable functions\\n            return integrand(math.tan(t)) / (math.cos(t)**2)\\n        \\n        transformed_integrand_fn = t_integrand\\n        transformed_lower = -math.pi / 2\\n        transformed_upper = math.pi / 2\\n        transformation_applied = True\\n\\n    elif upper_limit == float('inf'):\\n        # Transformation for [a, inf) to [0, 1) using x = a + t / (1 - t)\\n        # dx = 1 / (1-t)^2 dt\\n        a = lower_limit\\n        def t_integrand(t):\\n            # Guard against division by zero or very large values near t=1\\n            if t >= 1.0 - 1e-10: \\n                return 0.0 # Assuming integrand * (1/(1-t)^2) approaches 0 for integrable functions\\n            x_val = a + t / (1 - t)\\n            return integrand(x_val) / ((1 - t)**2)\\n        \\n        transformed_integrand_fn = t_integrand\\n        transformed_lower = 0.0\\n        transformed_upper = 1.0\\n        transformation_applied = True\\n\\n    elif lower_limit == float('-inf'):\\n        # Transformation for (-inf, b] to [0, 1) using x = b - t / (1 - t)\\n        # dx = -1 / (1-t)^2 dt\\n        b = upper_limit\\n        def t_integrand(t):\\n            # Guard against division by zero or very large values near t=1\\n            if t >= 1.0 - 1e-10: \\n                return 0.0 # Assuming integrand * (-1/(1-t)^2) approaches 0 for integrable functions\\n            x_val = b - t / (1 - t)\\n            return -integrand(x_val) / ((1 - t)**2)\\n        \\n        transformed_integrand_fn = t_integrand\\n        transformed_lower = 0.0\\n        transformed_upper = 1.0\\n        transformation_applied = True\\n\\n    if transformation_applied:\\n        try:\\n            val_t, err_t = scipy.integrate.quad(transformed_integrand_fn, transformed_lower, transformed_upper, limit=1000)\\n            if math.isfinite(val_t) and (err_t < 1e-6 or (val_t != 0 and err_t / abs(val_t) < 1e-6)):\\n                return val_t, err_t # Transformed integral converged well\\n            \\n            # If transformed integral also failed (NaN or high error), store and proceed.\\n            # print(f\\"scipy.integrate.quad with transformation resulted in NaN or high error: value={val_t}, error={err_t}\\")\\n            pass # Fall through to returning the initial result, or indicating full failure.\\n        except Exception as e:\\n            # print(f\\"scipy.integrate.quad with transformation raised exception: {e}\\")\\n            pass\\n\\n    # --- Final Fallback: Return initial result or indicate total failure ---\\n    # If no strategy above yielded a clean, precise result, return the best available\\n    # result from the initial \`quad\` attempt. If that was also bad (NaN, Inf),\\n    # indicate a complete failure.\\n    if math.isfinite(initial_value) and not math.isnan(initial_value):\\n        return initial_value, initial_error # Return the initial quad attempt result\\n    else:\\n        # If even the initial quad attempt was NaN or inf, or raised an exception.\\n        return float('nan'), float('inf') # Indicate complete failure to converge"
}`);
        const originalCode = codes["old_code"];
        const modifiedCode = codes["new_code"];
        const originalIndex = codes["old_index"];
        const modifiedIndex = codes["new_index"];

        function displaySideBySideDiff(originalText, modifiedText) {
          const diff = Diff.diffLines(originalText, modifiedText);

          let originalHtmlLines = [];
          let modifiedHtmlLines = [];

          const escapeHtml = (text) =>
            text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

          diff.forEach((part) => {
            // Split the part's value into individual lines.
            // If the string ends with a newline, split will add an empty string at the end.
            // We need to filter this out unless it's an actual empty line in the code.
            const lines = part.value.split("\n");
            const actualContentLines =
              lines.length > 0 && lines[lines.length - 1] === "" ? lines.slice(0, -1) : lines;

            actualContentLines.forEach((lineContent) => {
              const escapedLineContent = escapeHtml(lineContent);

              if (part.removed) {
                // Line removed from original, display in original column, add blank in modified.
                originalHtmlLines.push(
                  `<span class="diff-line diff-removed">${escapedLineContent}</span>`,
                );
                // Use &nbsp; for consistent line height.
                modifiedHtmlLines.push(`<span class="diff-line">&nbsp;</span>`);
              } else if (part.added) {
                // Line added to modified, add blank in original column, display in modified.
                // Use &nbsp; for consistent line height.
                originalHtmlLines.push(`<span class="diff-line">&nbsp;</span>`);
                modifiedHtmlLines.push(
                  `<span class="diff-line diff-added">${escapedLineContent}</span>`,
                );
              } else {
                // Equal part - no special styling (no background)
                // Common line, display in both columns without any specific diff class.
                originalHtmlLines.push(`<span class="diff-line">${escapedLineContent}</span>`);
                modifiedHtmlLines.push(`<span class="diff-line">${escapedLineContent}</span>`);
              }
            });
          });

          // Join the lines and set innerHTML.
          originalDiffOutput.innerHTML = originalHtmlLines.join("");
          modifiedDiffOutput.innerHTML = modifiedHtmlLines.join("");
        }

        // Initial display with default content on DOMContentLoaded.
        displaySideBySideDiff(originalCode, modifiedCode);

        // Title the texts with their node numbers.
        originalTitle.textContent = `Parent #${originalIndex}`;
        modifiedTitle.textContent = `Child #${modifiedIndex}`;
      }

      // Load the jsdiff script when the DOM is fully loaded.
      document.addEventListener("DOMContentLoaded", loadJsDiff);
    </script>
  </body>
</html>
